import c-crdlib.utils.ClientUId
import c-crdtlib.utils.VersionVector

class Session {

  // The client unique id
  private cliendUId: CliendUId

  // Current consistency level
  private consistency: ConsistencyLevel?

  // The attached service handler
  private serviceHandler: ServiceHandler

  // Current running transaction
  private currentTransaction: Transaction?

  // Transaction environment
  package txnEnv: TransactionEnvironment

  // Map for dirty Concordant objects
  package dirtyObjects: Map<CObjectUId, CObject>

  // Map for the cache of Concordant objects
  package cache: Map<CObjectUId, CObject>

  // Map for Concordant object handlers management
  package handlers: Map<CObjectUId, NotificationHandler>

  private Session(cid: ClientUId) {
    this.clientUId = cid
    this.txnEnv = TransactionEnvironment(this.clientUId)
    this.dirtyObjects = mutableMapOf()
    this.cache = mutableMapOf()
    this.handlers = mutableMapOf()
    this.serviceHandler = ServiceHandler()
    this.serviceHandler.run()
    this.currentTransaction = null
  }

  // c_begin_session
  static fun connect(dbName: String, credentials: String): Session {
    if (NOT ActiveSession == null) throw Exception
    clientId = ClientUId()
    if (NOT SERVICE.connect(dbName, credentials, clientUId)) throw Exception
    ActiveSession = Session(clientUId)
    retur ActiveSession
  }

  // c_pull_XX_view
  fun pull(type: ConsistencyLevel) {
    if (NOT this.currentTransaction == null) throw Exception
    if (this.consistency != null AND this.consistency > type) throw Exception
    this.consistency = type
    for oid in this.cache {
      crdt, v = SERVICE.getObject(oid, this.consistency)
      obj = this.cache.get(oid)
      obj.crdt = crdt
      this.txnEnv.updateSate(v)
    } 
  }

  // c_pull_XX_view(v)
  fun pull(type: ConsistencyLevel, vv: VersionVector) {
    if (NOT this.currentTransaction == null) throw Exception
    if (this.consistency != null AND this.consistency > type) throw Exception
    if (vv < this.txnEnv.getState()) throw Exception
    this.consistency = type
    for oid in this.cache {
      crdt, v = SERVICE.getObject(oid, vv, this.consistency)
      obj = this.cache.get(oid)
      obj.crdt = crdt
      this.txnEnv.updateSate(v)
    } 
  }
  
  // c_open_collection_read|write
  fun openCollection(cid: CollectionUId, readOnly: Boolean): Collection {
    if (NOT this.currentTransaction == null) throw Exception
    return Collection(cid, readOnly)
  }

  // c_XX_txn
  fun transaction(body: TransactionBody) {
    if (NOT this.currentTransaction == null) throw Exception
    this.currentTransaction = Transaction(body)
  }

  // c_end_session
  fun close() {
    if (this.currentTransaction == null) this.currentTransaction.abort()
    SERVICE.close(clientUId)
    this.serviceHandler.stop()
    ActiveSession = null
  }
}
