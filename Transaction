class Transaction {

  // Transaction id
  private transactionId: TxnId

  // Static boolean used to ensure that only one collection is openned
  private static otherOpenned: Boolean = false

  // The version vector at which the transaction has started
  private begin: VersionVector

  Transaction(tid: TxnId, body: TransactionBody) {
    if (Transaction.otherOpenned) throw Exception
    Transaction.otherOpenned = true
    this.begin = Global.TxnEnv.getState()
    this.transactionId = Global.TxnEnv.tickTransaction()

    try {
      // call the body function
      body()
      // if everything goes well commit
      this.commit()
    } catch {
      // If there is an exception abort
      this.abort()
    }
  }

  // c_abort_txn
  fun abort() {
    for obj in Global.DirtyCObjects {
      obj.txnAbort()
    }
    Global.DirtyCObjects.clear()
    Transaction.otherOpenned = false    
  }

  // c_commit_txn
  fun commit() {
    SERVICE.beginTransaction(this.transactionId)
    for obj in Global.DirtyCObjects {
      SERVICE.pushObject(obj.crdt.getDelta(this.begin))
      obj.txnCommit()
    }
    SERVICE.commitTransaction(this.transactionId)
    Global.DirtyCObjects.clear()
    Transaction.otherOpenned = false    
  }
}
